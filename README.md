# DocScrubber

**A powerful command-line toolkit for batch processing, optimizing, and repairing Microsoft Word `.docx` files.**

## The Philosophy

Microsoft Word is a powerful editor, but over time, documents can accumulate a significant amount of "bloat." This invisible data—such as embedded fonts, a long history of tracked changes, comments, and un-deletable image data—can swell a simple text document from a few kilobytes to many megabytes.

**DocScrubber** was built to fight this bloat. It provides a suite of surgical and aggressive tools to analyze, clean, and rebuild `.docx` files, giving you back control over your documents' file sizes. Whether you need to perform a precise optimization or simply nuke all the bloat with a total rebuild, this tool provides a way.

---

### Core Features

- **Self-Installing:** Automatically checks for required packages and prompts to install them on first run.
- **Rebuild:** The "nuclear option." Creates a brand-new, clean version of a document to eliminate all possible bloat. Preserves basic formatting.
- **Optimize:** Surgically removes specific sources of bloat like embedded fonts, unused images, and large images without a full rebuild.
- **Split & Merge:** A set of simple utilities to break apart and reassemble plain-text versions of documents.
- **Clean:** A safe, interactive command to remove all files generated by this tool from your workspace.
- **Batch Processing:** All commands can operate on either a single file or an entire directory.

---

### Prerequisites

- [Node.js](https://nodejs.org/) (v16 or later recommended)
- NPM (comes bundled with Node.js)

---

### Installation

Getting started is designed to be as simple as possible.

1. Clone the repository:
  
  ```bash
  git clone [https://github.com/your-username/doc-scrubber.git](https://github.com/your-username/doc-scrubber.git)
  ```
  
2. Navigate into the project directory:
  
  ```bash
  cd doc-scrubber
  ```
  
3. Run any command!
  
  ```bash
  node . --help
  ```
  
  The script will **automatically detect** if you have all the necessary packages. If any are missing, it will list them and ask for your permission to install them for you via `npm`.
  
  (Alternatively, if you prefer to install dependencies manually, you can run `npm install` before your first use.)
  

---

### Command Reference

This tool provides five main commands: `rebuild`, `optimize`, `split`, `merge`, and `clean`.

#### `rebuild`

This is your most powerful tool against bloat. It extracts the final, visible content of a document and builds a brand new, perfectly clean `.docx` file from it. This is the best way to fix files that are large due to tracked changes, comments, or other unknown XML data.

**Strategy:** Use `rebuild` when `optimize` doesn't significantly reduce the file size, or when you want to create the absolute smallest, cleanest version of a document possible.

**Trade-offs:** The rebuild process preserves basic formatting (headings, bold, italic, lists, tables, hyperlinks) but is not guaranteed to perfectly replicate complex layouts. It will remove headers, footers, text boxes, columns, and custom style definitions.

**Syntax:**
`node . rebuild <path-to-file-or-folder> [--overwrite] [--force]`

**Examples:**

```bash

# Rebuild a single file, creating MyDoc_rebuilt.docx

node . rebuild "./docs/MyDoc.docx"

# Rebuild all files in a folder, overwriting the originals after a confirmation prompt

node . rebuild "./docs" --overwrite

#### `optimize`

This command performs targeted, surgical optimizations on a document without changing its content or layout. It's less aggressive than `rebuild` but safer for preserving complex formatting.

**Syntax:** `node . optimize <path> [options]`

**Options:**

- `--remove-embedded-fonts`
  
  - **What it does:** Deletes the `word/fonts` folder and removes all references from the document's relationship and settings files.
  - **Best for:** Files bloated by embedded font data. The resulting document will rely on the required fonts being installed on the viewer's system.
- `--remove-unused-media`
  
  - **What it does:** Scans the document to see which images are actually displayed and deletes any "orphaned" image data that is no longer referenced.
  - **Best for:** Cleaning up documents where many images have been added and deleted over time.
- `--recompress-images`
  
  - **What it does:** Finds every JPEG and PNG image and re-compresses it. This is a "lossy" process that can significantly reduce file size at the cost of some image quality.
  - **Best for:** Documents with many high-resolution photos or unoptimized screenshots.
- `--image-quality <1-100>`
  
  - Sets the quality for image re-compression (default: 80). Lower numbers mean smaller size and lower quality.
- `--overwrite` & `--force`
  
  - Overwrites the original file. Use with caution. The `--force` flag (alias `-y`) skips the confirmation prompt.

---

#### `split` & `merge`

A pair of simple utilities for breaking apart and reassembling the *plain text* content of documents.

**Syntax:** `node . split <path> --by parts --value <number>` `node . merge <path> [--delete] [--use-original-name]`

**Note:** These commands discard all formatting and are intended for content manipulation, not layout preservation.

---

#### `clean`

Removes all files generated by DocScrubber from a directory.

**Syntax:** `node . clean <path> [--force]`

It finds files ending with `_rebuilt.docx`, `_optimized.docx`, `_merged.docx`, and split files like `_01.docx`. It will always ask for confirmation unless the `--force` flag is used.

---

### Technical Details

- A `.docx` file is a ZIP archive containing a structured collection of XML files and media folders. This tool works by unzipping the document in memory, performing targeted manipulations on these internal files, and then re-zipping the result.
- **Key Dependencies:**
  - `yargs`: Powers the command-line interface.
  - `mammoth`: Used by `rebuild` for extracting clean HTML and text content.
  - `jszip`: The core engine for reading and writing the `.docx` (ZIP) archive.
  - `fast-xml-parser`: Used by `optimize` to parse and rebuild internal XML files like `styles.xml`.
  - `sharp`: A high-performance library used by `optimize` for re-compressing images.
  - `html-to-docx`: Used by `rebuild` to convert the clean HTML back into a `.docx` file.

---

### Troubleshooting & FAQ

**Q: I ran `optimize`, but my file is still huge.** **A:** The bloat is almost certainly from tracked changes or comments embedded in the main content of the document. The `optimize` command cannot safely touch this. **Use the `rebuild` command instead.** This is its primary purpose.

**Q: My formatting and layout changed after using `rebuild`.** **A:** This is expected behavior. `rebuild` prioritizes creating a clean, small file by building it from scratch. It preserves basic semantic formatting (headings, lists, bold, etc.) but discards complex, page-level layouts (headers, footers, columns, etc.).

**Q: I got an error installing the `sharp` dependency.** **A:** `sharp` compiles native code during installation and may require system build tools (like `make`, `g++`, Python on Linux/macOS, or Visual Studio Build Tools on Windows). Please refer to the official [sharp installation documentation](https://sharp.pixelplumbing.com/install) for platform-specific requirements.

---

### License

This project is licensed under the MIT License.
